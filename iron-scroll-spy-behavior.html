<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-selector/iron-selectable.html">
<link rel="import" href="../iron-scroll-target-behavior/iron-scroll-target-behavior.html">

<script>
  /** @polymerBehavior Polymer.IronScrollSpyBehaviorImpl */
  Polymer.IronScrollSpyBehaviorImpl = {

    properties: {
      /**
       * When true, the selection is not updated anymore from the scroll event.
       * @type {Boolean}
       */
      disabled: {
        type: Boolean,
        value: false,
        observer: '_disableChanged'
      }
    },

    listeners: {
      'iron-items-changed': '_initCheck'
    },

    _disableChanged: function(newValue, oldValue) {
      if (oldValue && !newValue) {
        this._updateTriggers();
      }
    },

    _scrollHandler: function() {
      if (!this.disabled && !this.isDebouncerActive('_scrollSpyCheck')) {
        this.debounce('_scrollSpyCheck', function() { 
          this._scrollSpyCheck();
        }, 200);
      }
      
    },

    _scrollSpyCheck: function() {
      var scrollTop = this.scrollTarget.scrollTop;
      if (this.lowerThreshold != null && scrollTop > this.lowerThreshold) {
        this.selectIndex(this.indexOf(this.selectedItem) + 1);
        this._updateTriggers();
      } else if (this.upperThreshold != null && scrollTop < this.upperThreshold) {
        this.selectIndex(this.indexOf(this.selectedItem) - 1);
        this._updateTriggers();
      }
    },

    _updateTriggers: function() {
      var index = this.indexOf(this.selectedItem);
      var selectedTop = this.selectedItem.offsetTop;
      var scrollTargetHalfHeight = this.scrollTarget.clientHeight/2;
      this.upperThreshold = index ? selectedTop - scrollTargetHalfHeight: null;
      this.lowerThreshold = (index != this.items.length -1) ? 
        selectedTop + this.selectedItem.clientHeight - scrollTargetHalfHeight: null;
    },

    _initCheck: function() {
      this.selectIndex(0);
      this._updateTriggers();
    }

  }

    /** @polymerBehavior */
  Polymer.IronScrollSpyBehavior = [
    Polymer.IronSelectableBehavior,
    Polymer.IronScrollTargetBehavior,
    Polymer.IronScrollSpyBehaviorImpl
  ];

</script>