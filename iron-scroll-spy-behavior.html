<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-selector/iron-selectable.html">
<link rel="import" href="../iron-scroll-target-behavior/iron-scroll-target-behavior.html">

<script>
  /** @polymerBehavior Polymer.IronScrollSpyBehavior */
  Polymer.IronScrollSpyBehaviorImpl = {

    properties: {
      /**
       * When true, the selection is not updated anymore from the scroll event. When disabled became false again, 'selected' updates itself.
       */
      spyDisabled: {
        type: Boolean,
        value: false,
        observer: '_spyDisableChanged'
      }
    },

    listeners: {
      'iron-items-changed': '_initCheck'
    },

    _spyDisableChanged: function(newValue, oldValue) {
      if (oldValue && !newValue) {
        this._updateTriggers();
      }
    },

    _scrollHandler: function() {
      if (!this.spyDisabled && !this.isDebouncerActive('_scrollSpyCheck')) {
        this.debounce('_scrollSpyCheck', function() { 
          this._scrollSpyCheck();
        }, 200);
      } 
    },

    _scrollSpyCheck: function() {
      if (this.lowerThreshold != null && this._scrollTop > this.lowerThreshold) {
        this.fire('iron-scroll-spy-activate');
        this.selectIndex(this.indexOf(this.selectedItem) + 1);
        this._updateTriggers();
      } else if (this.upperThreshold != null && this._scrollTop < this.upperThreshold) {
        this.fire('iron-scroll-spy-activate');
        this.selectIndex(this.indexOf(this.selectedItem) - 1);
        this._updateTriggers();
      }
    },

    _updateTriggers: function() {
      if (this.selectedItem) {
        var index = this.indexOf(this.selectedItem);
        var selectedTop = this.selectedItem.offsetTop;
        var scrollTargetHalfHeight = this.scrollTarget.clientHeight/2;
        this.upperThreshold = index ? selectedTop - scrollTargetHalfHeight: null;
        this.lowerThreshold = (index != this.items.length -1) ? 
          selectedTop + this.selectedItem.clientHeight - scrollTargetHalfHeight: null;
      }
    },

    _initCheck: function() {
      //TODO: select the current item in the viewport.
      this.selectIndex(0);
      this._updateTriggers();
    }
  }

  /** @polymerBehavior */
  Polymer.IronScrollSpyBehavior = [
    Polymer.IronSelectableBehavior,
    Polymer.IronScrollTargetBehavior,
    Polymer.IronScrollSpyBehaviorImpl
  ];

</script>