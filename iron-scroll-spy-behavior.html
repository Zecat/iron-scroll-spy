<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-selector/iron-selectable.html">
<link rel="import" href="../iron-scroll-target-behavior/iron-scroll-target-behavior.html">

<script>
  /** @polymerBehavior Polymer.IronScrollSpyBehavior */
  Polymer.IronScrollSpyBehaviorImpl = {

    properties: {
      /**
       * When true, the selection is not updated anymore from the scroll event. When disabled became false again, 'selected' updates itself.
       */
      spyDisabled: {
        type: Boolean,
        value: false,
        observer: '_spyDisableChanged'
      },
      /**
       * For performance reason, calls to the `spyCheck` method are debounced according to `spyCheckFrequence`'s value (ms).
       */
      spyCheckFrequence: {
        type: Number,
        value: 200
      }
    },

    listeners: {
      'iron-items-changed': '_initCheck'
    },

    _spyDisableChanged: function(newValue, oldValue) {
      if (oldValue && !newValue) {
        this._updateTriggers();
      }
    },

    _scrollHandler: function() {
      if (!this.spyDisabled && !this.isDebouncerActive('spyCheck')) {
        this.debounce('spyCheck', function() { 
          this.spyCheck();
        }, this.spyCheckFrequence);
      } 
    },
    /**
     * Check if an item as been reach by the scroll and should be selected. This method will be called automatically as the scroll-target is scrolled.
     */
    spyCheck: function() {
      var progress = (this.lowerThreshold != null && this._scrollTop > this.lowerThreshold) ? 1 :
      ( (this.upperThreshold != null && this._scrollTop < this.upperThreshold) ? -1 : 0 );
      if (progress) {
        this.fire('iron-scroll-spy-activate');
        progress > 0 ? this.selectNext() : this.selectPrevious();
        this._updateTriggers();
        this.spyCheck();
      }
    },

    _updateTriggers: function() {
      if (this.selectedItem) {
        var index = this.indexOf(this.selectedItem);
        var selectedTop = this.selectedItem.offsetTop;
        var scrollTargetHalfHeight = this.scrollTarget.clientHeight/2;
        this.upperThreshold = index ? selectedTop - scrollTargetHalfHeight: null;
        this.lowerThreshold = (index != this.items.length -1) ? 
          selectedTop + this.selectedItem.clientHeight - scrollTargetHalfHeight: null;
      }
    },

    _initCheck: function() {
      //TODO: select the current item in the viewport.
      this.selectIndex(0);
      this._updateTriggers();
    }
  }

  /** @polymerBehavior */
  Polymer.IronScrollSpyBehavior = [
    Polymer.IronSelectableBehavior,
    Polymer.IronScrollTargetBehavior,
    Polymer.IronScrollSpyBehaviorImpl
  ];

</script>